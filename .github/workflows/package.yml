name: Package Repository

on:
  push:
    branches:
      - main
    paths:
      - '_repos/**'
      - 'resources/**'
      - 'localization/**'
      - '.gitmodules'
      - '.github/workflows/package.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.1.5
      with:
        submodules: true
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Per-mod re-arranging
      run: |
        echo "Start re-arranging mod files..."

        mv _repos Mods
        cd Mods

        rm -rf Betmma/5_legendary_challenges

        mv BonusBlinds/BonusBlinds/* BonusBlinds/

        mv CheesyJokers/CheesyJokers/* CheesyJokers/

        mv CodexArcanum/mod .
        rm -rf CodexArcanum
        mv mod CodexArcanum

        mv CruelBlinds/CruelBlinds_1_0_0 .
        rm -rf CruelBlinds
        mv CruelBlinds_1_0_0 CruelBlinds

        mkdir je_t
        mv JokerEvolution/JokerEvolution/* je_t
        rm -rf JokerEvolution
        mv je_t JokerEvolution

        rm -rf KCVanilla/scripts

        mv "SDM0/SDM_0's Stuff" "SDM_0's Stuff"
        rm -rf SDM0

        rm -rf Steamodded/example_mods

    - name: Universal unwanted files/directories removal
      run: |
        echo "Start deleting redundant files..."
        rm -rf .git .gitmodules
        pushd ./Mods
        find . -maxdepth 2 -type f -name 'icon.png' -exec rm -f {} +
        find . -maxdepth 2 -type f -name 'm6x11plus.ttf' -exec rm -f {} +
        find . -maxdepth 2 -type f -name 'manifest.json' -exec rm -f {} +
        popd
        find . -type f -iname 'LICENSE' -exec rm -f {} +
        find . -type f -iname 'TODO' -exec rm -f {} +
        find . -type f -iname '*.md' -exec rm -f {} +
        find . -type f -iname '*.fish' -exec rm -f {} +
        find . -type f -iname '*.asc' -exec rm -f {} +
        find . -type f -iname '*.html' -exec rm -f {} +
        find . -type f -iname '*.js' -exec rm -f {} +
        find . -type f -iname '*.css' -exec rm -f {} +
        find . -type f -iname '.git' -exec rm -f {} +
        find . -type f -iname '.luarc.json' -exec rm -f {} +
        find . -type f -iname '.gitignore' -exec rm -f {} +
        find . -type f -iname '.gitattributes' -exec rm -f {} +
        find . -type d -name 'site' -exec rm -rf {} +
        find . -type d -iname '.vscode' -exec rm -rf {} +
        find . -type d -iname '.github' -exec rm -rf {} +
        find . -type d -name 'gitresources' -exec rm -rf {} +

    - name: Upload artifact
      uses: actions/upload-artifact@v4.3.3
      with:
        name: pack_snapshot
        path: ./
